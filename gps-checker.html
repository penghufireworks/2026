<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¾æ¹–ç¾é£Ÿåœ°åœ– GPS åº§æ¨™æª¢æŸ¥å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #1e293b;
            margin-bottom: 10px;
        }
        .instructions {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .instructions h2 {
            color: #0ea5e9;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #fff;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex: 1;
        }
        .stat-card h3 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 5px;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #1e293b;
        }
        .place-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .place-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .place-name {
            font-size: 20px;
            font-weight: bold;
            color: #1e293b;
        }
        .place-meta {
            font-size: 14px;
            color: #64748b;
        }
        .coords {
            font-family: 'Courier New', monospace;
            background: #f1f5f9;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .map-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #0ea5e9;
            color: white;
        }
        .btn-primary:hover {
            background: #0284c7;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status-checked {
            background: #d1fae5;
            color: #065f46;
        }
        .status-corrected {
            background: #dbeafe;
            color: #1e40af;
        }
        .export-section {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .export-section h2 {
            color: #1e293b;
            margin-bottom: 15px;
        }
        #exportData {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            resize: vertical;
        }
        .coord-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        .coord-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .coord-input input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        .quick-action {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #e2e8f0;
        }
        .quick-action h4 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }
        .batch-update-btn {
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }
        .batch-update-btn:hover {
            background: #059669;
        }
        .batch-update-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        .filter-bar {
            background: #fff;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ æ¾æ¹–ç¾é£Ÿåœ°åœ– GPS åº§æ¨™æª¢æŸ¥å·¥å…·</h1>
        <p style="color: #64748b; margin-bottom: 20px;">é€ä¸€æª¢æŸ¥æ¯å®¶åº—çš„ Google Maps ä½ç½®ï¼Œç¢ºèªåº§æ¨™æ˜¯å¦æ­£ç¢º</p>
        <div class="login-panel" style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <div>
                <span id="loginStatus">ğŸ”’ æœªç™»å…¥ (å”¯è®€æ¨¡å¼)</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="password" id="githubToken" placeholder="GitHub Token" style="padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 4px; display: none;">
                <button id="loginBtn" class="btn btn-primary" onclick="toggleLogin()">ç™»å…¥ GitHub</button>
                <button id="saveToGithubBtn" class="btn btn-success" onclick="saveToGithub()" style="display: none;">ğŸ’¾ å„²å­˜åˆ° GitHub</button>
            </div>
        </div>

        <div class="instructions">
            <h2>ğŸ“‹ ä½¿ç”¨èªªæ˜ï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰</h2>
            <ol>
                <li>é»æ“Šã€ŒğŸš€ å¿«é€Ÿæª¢æŸ¥ã€æŒ‰éˆ•ï¼Œæœƒåœ¨æ–°åˆ†é æ‰“é–‹ Google Maps</li>
                <li>åœ¨ Google Maps ä¸­æ‰¾åˆ°åº—å®¶ä½ç½®ï¼Œå³éµé»æ“Šå–å¾—åº§æ¨™</li>
                <li>åº§æ¨™æœƒè‡ªå‹•è¤‡è£½ï¼Œå›åˆ°æœ¬é é¢ï¼Œé»æ“Šã€ŒğŸ“ è²¼ä¸Šåº§æ¨™ã€æŒ‰éˆ•</li>
                <li>åº§æ¨™æœƒè‡ªå‹•å¡«å…¥ï¼Œç¢ºèªå¾Œé»æ“Šã€Œâœ“ ç¢ºèªåº§æ¨™ã€</li>
                <li>é‡è¤‡ä»¥ä¸Šæ­¥é©Ÿæª¢æŸ¥æ‰€æœ‰åº—å®¶</li>
                <li>æœ€å¾Œé»æ“Šã€ŒğŸ”„ æ‰¹æ¬¡æ›´æ–°å…¨éƒ¨ã€æŒ‰éˆ•</li>
            </ol>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>ç¸½åº—å®¶æ•¸</h3>
                <div class="number" id="totalCount">0</div>
            </div>
            <div class="stat-card">
                <h3>å·²æª¢æŸ¥</h3>
                <div class="number" id="checkedCount" style="color: #10b981;">0</div>
            </div>
            <div class="stat-card">
                <h3>éœ€ä¿®æ­£</h3>
                <div class="number" id="correctedCount" style="color: #f59e0b;">0</div>
            </div>
            <div class="stat-card">
                <h3>å¾…æª¢æŸ¥</h3>
                <div class="number" id="pendingCount" style="color: #64748b;">0</div>
            </div>
        </div>

        <div class="filter-bar">
            <label>ç¯©é¸ï¼š</label>
            <select id="filterStatus" onchange="filterPlaces()">
                <option value="all">å…¨éƒ¨</option>
                <option value="pending">å¾…æª¢æŸ¥</option>
                <option value="checked">å·²ç¢ºèªæ­£ç¢º</option>
                <option value="corrected">éœ€è¦ä¿®æ­£</option>
            </select>
            <select id="filterArea" onchange="filterPlaces()">
                <option value="all">æ‰€æœ‰åœ°å€</option>
            </select>
        </div>

        <div id="placesList"></div>

        <div class="export-section">
            <h2>ğŸ”„ æ‰¹æ¬¡æ›´æ–°</h2>
            <p style="color: #64748b; margin-bottom: 10px;">
                å·²æ¨™è¨˜ <strong id="correctionCount">0</strong> å€‹éœ€è¦ä¿®æ­£çš„åº§æ¨™
            </p>
            <button class="batch-update-btn" id="batchUpdateBtn" onclick="batchUpdate()" disabled>
                ğŸ”„ æ‰¹æ¬¡æ›´æ–°å…¨éƒ¨ï¼ˆç”Ÿæˆæ›´æ–°æŒ‡ä»¤ï¼‰
            </button>
            <div style="margin-top: 15px;">
                <h3 style="font-size: 16px; margin-bottom: 10px;">æ›´æ–°æŒ‡ä»¤ï¼š</h3>
                <textarea id="exportData" readonly></textarea>
                <button class="btn btn-primary" onclick="copyExport()" style="margin-top: 10px;">ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
            </div>
        </div>
    </div>

    <script>
        let foodPlaces = [];
        let places = [];


const foodCategories = [
  {
    "id": "all",
    "name": "å…¨éƒ¨ç¾é£Ÿ",
    "icon": "ğŸ½ï¸",
    "color": "bg-slate-800"
  },
  {
    "id": "breakfast",
    "name": "æ—©é¤/æ—©åˆé¤",
    "icon": "ğŸ³",
    "color": "bg-yellow-500"
  },
  {
    "id": "seafood",
    "name": "æµ·é®®æ–™ç†",
    "icon": "ğŸŸ",
    "color": "bg-blue-500"
  },
  {
    "id": "snack",
    "name": "åœ¨åœ°å°åƒ",
    "icon": "ğŸ¡",
    "color": "bg-orange-500"
  },
  {
    "id": "restaurant",
    "name": "ç•°åœ‹/ç‰¹è‰²é¤å»³",
    "icon": "ğŸ´",
    "color": "bg-red-500"
  },
  {
    "id": "dessert",
    "name": "ç”œé»å†°å“",
    "icon": "ğŸ§",
    "color": "bg-pink-500"
  },
  {
    "id": "drink",
    "name": "å’–å•¡é£²å“",
    "icon": "â˜•",
    "color": "bg-emerald-500"
  },
  {
    "id": "souvenir",
    "name": "ä¼´æ‰‹ç¦®",
    "icon": "ğŸ",
    "color": "bg-purple-500"
  }
];
        
        
        function initPlaces() {
            places = foodPlaces.map(p => ({
            ...p,
            status: 'pending',
            newLat: null,
            newLng: null
        }));

        // è¼‰å…¥å·²å„²å­˜çš„ç‹€æ…‹
        const savedData = localStorage.getItem('gpsCheckData');
        if (savedData) {
            const saved = JSON.parse(savedData);
            places = places.map(p => {
                const savedPlace = saved.find(s => s.id === p.id);
                return savedPlace ? { ...p, ...savedPlace } : p;
            });
        }

        // åˆå§‹åŒ–åœ°å€ç¯©é¸
        const areas = [...new Set(places.map(p => p.area))].sort();
        const areaSelect = document.getElementById('filterArea');
        areas.forEach(area => {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            areaSelect.appendChild(option);
        });

        
            updateStats(); // Ensure stats are updated
            renderPlaces(); // Ensure list is rendered
        }
        
        function saveData() {
            localStorage.setItem('gpsCheckData', JSON.stringify(places));
            updateStats();
            updateExport();
        }

        function updateStats() {
            const checked = places.filter(p => p.status === 'checked').length;
            const corrected = places.filter(p => p.status === 'corrected').length;
            const pending = places.filter(p => p.status === 'pending').length;

            document.getElementById('totalCount').textContent = places.length;
            document.getElementById('checkedCount').textContent = checked;
            document.getElementById('correctedCount').textContent = corrected;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('correctionCount').textContent = corrected;
            
            const btn = document.getElementById('batchUpdateBtn');
            btn.disabled = corrected === 0;
            btn.textContent = `ğŸ”„ æ‰¹æ¬¡æ›´æ–°å…¨éƒ¨ï¼ˆ${corrected} å€‹ä¿®æ­£ï¼‰`;
        }

        function markAsChecked(id) {
            const place = places.find(p => p.id === id);
            place.status = 'checked';
            saveData();
            renderPlaces();
        }

        function markAsCorrected(id) {
            const place = places.find(p => p.id === id);
            const newCoords = prompt(`è«‹è¼¸å…¥ ${place.name} çš„æ­£ç¢ºåº§æ¨™ï¼ˆæ ¼å¼ï¼šç·¯åº¦, ç¶“åº¦ï¼‰\nä¾‹å¦‚ï¼š23.5701, 119.571`);
            
            if (newCoords) {
                const [lat, lng] = newCoords.split(',').map(s => parseFloat(s.trim()));
                if (!isNaN(lat) && !isNaN(lng)) {
                    place.newLat = lat;
                    place.newLng = lng;
                    place.status = 'corrected';
                    saveData();
                    renderPlaces();
                } else {
                    alert('åº§æ¨™æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡è©¦');
                }
            }
        }

        function updateExport() {
            const corrections = places.filter(p => p.status === 'corrected');
            
            // æ›´æ–°æ‰¹æ¬¡æ›´æ–°æŒ‰éˆ•
            const batchBtn = document.getElementById('batchUpdateBtn');
            const countSpan = document.getElementById('correctionCount');
            
            if (corrections.length === 0) {
                document.getElementById('exportData').value = 'ç›®å‰æ²’æœ‰éœ€è¦ä¿®æ­£çš„åº§æ¨™';
                batchBtn.disabled = true;
                countSpan.textContent = '0';
                return;
            }

            countSpan.textContent = corrections.length;
            batchBtn.disabled = false;

            let output = `ç™¼ç¾ ${corrections.length} å€‹éœ€è¦ä¿®æ­£çš„åº§æ¨™ï¼š\n\n`;
            corrections.forEach(p => {
                output += `${p.name}: ${p.newLat}, ${p.newLng}\n`;
            });
            
            output += `\n\næ‰¹é‡æ›´æ–°æŒ‡ä»¤ï¼ˆè¤‡è£½ä»¥ä¸‹æ‰€æœ‰æŒ‡ä»¤ï¼‰ï¼š\n\n`;
            corrections.forEach(p => {
                output += `node scripts/update_single_gps.js "${p.name}" ${p.newLat} ${p.newLng}\n`;
            });

            document.getElementById('exportData').value = output;
        }

        function copyExport() {
            const textarea = document.getElementById('exportData');
            textarea.select();
            document.execCommand('copy');
            alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }

        window.markAsChecked = markAsChecked;
        window.markAsCorrected = markAsCorrected;
        window.copyExport = copyExport;

        let currentFilter = { status: 'all', area: 'all' };

        window.filterPlaces = function() {
            currentFilter.status = document.getElementById('filterStatus').value;
            currentFilter.area = document.getElementById('filterArea').value;
            renderPlaces();
        };

        function renderPlaces() {
            let filtered = places;
            
            if (currentFilter.status !== 'all') {
                filtered = filtered.filter(p => p.status === currentFilter.status);
            }
            
            if (currentFilter.area !== 'all') {
                filtered = filtered.filter(p => p.area === currentFilter.area);
            }

            const html = filtered.map(place => {
                const statusClass = `status-${place.status}`;
                const statusText = {
                    pending: 'â³ å¾…æª¢æŸ¥',
                    checked: 'âœ“ å·²ç¢ºèª',
                    corrected: 'âœï¸ éœ€ä¿®æ­£'
                }[place.status];

                const coords = place.status === 'corrected' 
                    ? `${place.newLat}, ${place.newLng} (æ–°)`
                    : `${place.lat}, ${place.lng}`;

                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name + ' æ¾æ¹–')}`;
                const coordsUrl = `https://www.google.com/maps?q=${place.lat},${place.lng}`;

                return `
                    <div class="place-card">
                        <div class="place-info">
                            <div>
                                <div class="place-name">${place.name}</div>
                                <div class="place-meta">
                                    ID: ${place.id} | ${place.category} | ${place.area}
                                    <span class="status ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div class="coords">
                                ğŸ“ ç›®å‰åº§æ¨™: ${place.lat}, ${place.lng}
                            </div>
                            ${place.status === 'corrected' ? `
                                <div class="coords" style="background: #dcfce7; border: 1px solid #86efac;">
                                    âœ“ æ–°åº§æ¨™: ${place.newLat}, ${place.newLng}
                                </div>
                            ` : ''}
                            <div class="quick-action">
                                <h4>ğŸš€ å¿«é€Ÿæª¢æŸ¥æµç¨‹ï¼š</h4>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="openGoogleMaps('${place.id}', '${googleMapsUrl}')">
                                        1ï¸âƒ£ æ‰“é–‹ Google Maps
                                    </button>
                                    <button class="btn btn-primary" onclick="pasteCoords('${place.id}')">
                                        2ï¸âƒ£ ğŸ“ è²¼ä¸Šåº§æ¨™
                                    </button>
                                    <button class="btn btn-success" onclick="confirmCoords('${place.id}')">
                                        3ï¸âƒ£ âœ“ ç¢ºèªåº§æ¨™
                                    </button>
                                </div>
                                <div class="coord-input" id="coordInput-${place.id}" style="display: none;">
                                    <input 
                                        type="text" 
                                        id="latInput-${place.id}" 
                                        placeholder="ç·¯åº¦ (ä¾‹å¦‚: 23.5745323)"
                                    />
                                    <input 
                                        type="text" 
                                        id="lngInput-${place.id}" 
                                        placeholder="ç¶“åº¦ (ä¾‹å¦‚: 119.5785797)"
                                    />
                                </div>
                            </div>
                            <div class="actions" style="margin-top: 10px;">
                                <button class="btn btn-success" onclick="markAsChecked('${place.id}')">
                                    âœ“ åº§æ¨™æ­£ç¢ºï¼ˆç„¡éœ€ä¿®æ”¹ï¼‰
                                </button>
                                <a href="${coordsUrl}" target="_blank" class="btn btn-primary">
                                    ğŸ—ºï¸ æŸ¥çœ‹ç›®å‰ä½ç½®
                                </a>
                            </div>
                        </div>
                        <div class="map-container">
                            <iframe 
                                width="100%" 
                                height="100%" 
                                frameborder="0" 
                                style="border:0"
                                src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${place.lat},${place.lng}&zoom=16"
                                allowfullscreen>
                            </iframe>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('placesList').innerHTML = html;
        }

        window.openGoogleMaps = function(id, url) {
            window.open(url, '_blank');
            // é¡¯ç¤ºåº§æ¨™è¼¸å…¥æ¡†
            document.getElementById(`coordInput-${id}`).style.display = 'flex';
        };

        window.pasteCoords = async function(id) {
            try {
                const text = await navigator.clipboard.readText();
                // å˜—è©¦è§£æåº§æ¨™æ ¼å¼
                // æ”¯æ´æ ¼å¼: "23.5745323, 119.5785797" æˆ– "23.5745323,119.5785797"
                const match = text.match(/([-+]?\d+\.\d+)[,\s]+([-+]?\d+\.\d+)/);
                
                if (match) {
                    const lat = match[1];
                    const lng = match[2];
                    document.getElementById(`latInput-${id}`).value = lat;
                    document.getElementById(`lngInput-${id}`).value = lng;
                    document.getElementById(`coordInput-${id}`).style.display = 'flex';
                    alert('âœ“ åº§æ¨™å·²è²¼ä¸Šï¼è«‹ç¢ºèªå¾Œé»æ“Šã€Œç¢ºèªåº§æ¨™ã€');
                } else {
                    alert('å‰ªè²¼ç°¿ä¸­æ²’æœ‰æ‰¾åˆ°åº§æ¨™æ ¼å¼\nè«‹åœ¨ Google Maps ä¸­å³éµé»æ“Šä½ç½®ï¼Œç„¶å¾Œé»æ“Šåº§æ¨™æ•¸å­—è¤‡è£½');
                }
            } catch (err) {
                alert('ç„¡æ³•è®€å–å‰ªè²¼ç°¿\nè«‹æ‰‹å‹•è¼¸å…¥åº§æ¨™ï¼Œæˆ–ç¢ºèªç€è¦½å™¨æ¬Šé™');
                document.getElementById(`coordInput-${id}`).style.display = 'flex';
            }
        };

        window.confirmCoords = function(id) {
            const lat = parseFloat(document.getElementById(`latInput-${id}`).value);
            const lng = parseFloat(document.getElementById(`lngInput-${id}`).value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§æ¨™');
                return;
            }
            
            const place = places.find(p => p.id === id);
            place.newLat = lat;
            place.newLng = lng;
            place.status = 'corrected';
            saveData();
            renderPlaces();
            
            alert(`âœ“ ${place.name} çš„åº§æ¨™å·²æ›´æ–°ï¼`);
        };

        window.batchUpdate = function() {
            updateExport();
            alert('æ›´æ–°æŒ‡ä»¤å·²ç”Ÿæˆï¼\nè«‹è¤‡è£½ä¸‹æ–¹çš„æŒ‡ä»¤çµ¦é–‹ç™¼è€…é€²è¡Œæ‰¹æ¬¡æ›´æ–°');
        };

        updateStats();
        updateExport();
        renderPlaces();
    
        // GitHub API Configuration
        const GITHUB_OWNER = 'penghufireworks';
        const GITHUB_REPO = '2026';
        const GITHUB_PATH = 'places.json';
        const GITHUB_BRANCH = 'main';

        document.addEventListener('DOMContentLoaded', () => {
            loadPlaces();
            checkLogin();
        });

        async function loadPlaces() {
            try {
                const response = await fetch('places.json?v=' + new Date().getTime());
                if (!response.ok) throw new Error('Failed to load places.json');
                foodPlaces = await response.json();
                initPlaces();
            } catch (error) {
                console.error('Error loading places:', error);
                alert('ç„¡æ³•è¼‰å…¥åº—å®¶è³‡æ–™ places.json');
            }
        }

        function checkLogin() {
            const token = localStorage.getItem('github_token');
            if (token) {
                document.getElementById('loginStatus').textContent = 'ğŸ”“ å·²ç™»å…¥ (å¯å¯«å…¥æ¨¡å¼)';
                document.getElementById('loginBtn').textContent = 'ç™»å‡º';
                document.getElementById('saveToGithubBtn').style.display = 'block';
                document.getElementById('githubToken').style.display = 'none';
            } else {
                document.getElementById('loginStatus').textContent = 'ğŸ”’ æœªç™»å…¥ (å”¯è®€æ¨¡å¼)';
                document.getElementById('loginBtn').textContent = 'ç™»å…¥ GitHub';
                document.getElementById('saveToGithubBtn').style.display = 'none';
                document.getElementById('githubToken').style.display = 'none';
            }
        }

        function toggleLogin() {
            const token = localStorage.getItem('github_token');
            if (token) {
                // Logout
                if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                    localStorage.removeItem('github_token');
                    checkLogin();
                }
            } else {
                // Show input
                const input = document.getElementById('githubToken');
                if (input.style.display === 'none') {
                    input.style.display = 'block';
                    input.focus();
                } else {
                    // Login
                    const newToken = input.value.trim();
                    if (newToken) {
                        localStorage.setItem('github_token', newToken);
                        checkLogin();
                    }
                }
            }
        }

        async function saveToGithub() {
            const token = localStorage.getItem('github_token');
            if (!token) return alert('è«‹å…ˆç™»å…¥');

            if (!confirm('ç¢ºå®šè¦å°‡è®Šæ›´å„²å­˜åˆ° GitHub å—ï¼Ÿé€™å°‡æœƒæ›´æ–°ç¶²ç«™ä¸Šçš„è³‡æ–™ã€‚')) return;

            const btn = document.getElementById('saveToGithubBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'â³ è®€å–ä¸­...';

            try {
                // 1. Get current SHA
                const getRes = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}?ref=${GITHUB_BRANCH}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getRes.ok) throw new Error('ç„¡æ³•è®€å– GitHub æª”æ¡ˆè³‡è¨Š (å¯èƒ½ Token ç„¡æ•ˆæˆ–æª”æ¡ˆä¸å­˜åœ¨)');
                const getData = await getRes.json();
                const sha = getData.sha;

                // 2. Prepare content
                // Apply corrections to foodPlaces
                const updatedPlaces = foodPlaces.map(p => {
                    const corrected = places.find(cp => cp.id === p.id && cp.status === 'corrected');
                    if (corrected) {
                        return { ...p, lat: corrected.newLat, lng: corrected.newLng };
                    }
                    return p;
                });

                // Convert to JSON and handle Unicode
                const contentStr = JSON.stringify(updatedPlaces, null, 2);
                
                // Proper UTF-8 to Base64
                const base64Content = btoa(unescape(encodeURIComponent(contentStr)));

                btn.textContent = 'ğŸ’¾ å„²å­˜ä¸­...';

                // 3. Update file
                const putRes = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'chore: update GPS coordinates via GPS Checker',
                        content: base64Content,
                        sha: sha,
                        branch: GITHUB_BRANCH
                    })
                });

                if (!putRes.ok) {
                    const err = await putRes.json();
                    throw new Error(err.message || 'å„²å­˜å¤±æ•—');
                }

                alert('âœ… å„²å­˜æˆåŠŸï¼GitHub Pages å°‡åœ¨å¹¾åˆ†é˜å¾Œæ›´æ–°ã€‚');
                
                // Clear local corrections as they are now saved
                places.forEach(p => {
                    if (p.status === 'corrected') p.status = 'checked';
                });
                saveData();
                renderPlaces();

            } catch (error) {
                console.error(error);
                alert('âŒ éŒ¯èª¤: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
</script>
</body>
</html>
